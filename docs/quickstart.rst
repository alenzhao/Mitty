Quick-start I
=============

(For an overview of how Mitty is structured and some of the conventions used please see the detailed documentation.
This quickstart is for the impatient - like me - who like to type in commands and see stuff happen and go from
there)

We will introduce Mitty via a data simulation problem. Let us say our colleague Heng Li has written an aligner
called ``bwa`` and we want to figure out how well it does at aligning.

Our plan is as follows:

* Sprinkle some variants on the reference genome to create a sample genome
* Take 10x Illumina like reads from this sample genome
* Use `bwa` to align the reads to the reference genome
* Assess how well `bwa` aligned the reads

*For this exercise we won't use the human chromosome but rather some test data included with the Mitty source
distribution in the `examples` directory. The commands for the entire example is available under `examples/complete`*

Note that Mitty expects each chromosome file to be stored in a separate fasta file with no newlines (Please see
:ref:`ref-genome`).

Adding variants
---------------
The example reference genome has four "chromosomes". Let's add SNPs to the first two. We will need the `denovo` program
for this. Let's look into what kind of models we have available:

.. command-output::  denovo models

Ok, the `snp` plugin sounds promising, what kind of parameters does it need?

.. command-output::  denovo explain snp

Ok, we also want a refresher on how to write the parameter file (and what the command line options are) for denovo:

.. command-output::  denovo

From this we first create a parameter file, let's call it `snp.json`:

.. literalinclude:: ../examples/complete/snp.json
    :language: json

Let's run this command and create a new genome (*We only use the -v option to see what's going on*).

.. command-output:: mkdir -p ../examples/complete/out
.. command-output::  denovo  --pfile=../examples/complete/snp.json -v

Let's take a peek at the produced vcf

.. command-output:: cat ../examples/complete/out/snp.vcf

Things seem to have run satisfactorily. Note that we produce phased VCF files and we also use the notation `1|0` since we
have complete knowledge of the phasing. (Please see :ref:`var-genome`). Now let's generate a bag of reads from this genome.

Taking reads
------------
Let's first figure out what kind of read models we have available to us.

.. command-output::  vcf2reads models
.. command-output::  vcf2reads models

`simple_illumina` sounds promising, what kind of parameter file does it need?

.. command-output::  vcf2reads explain simple_illumina

What parameters do we need to call `vcf2reads` and how do we structure the parameters file?

.. command-output:: vcf2reads

From this we first create a parameter file, let's call it `illumina_reads.json`:

.. literalinclude:: ../examples/complete/illumina_reads.json
    :language: json

Let's run this command and create some reads from the variant genome

.. command-output::  vcf2reads  --pfile=../examples/complete/illumina_reads.json -v


Creating a cheat alignment
--------------------------
We can use `reads2bam.py` to create a cheat alignment ...

.. command-output::  reads2bam -p --fa_dir=../examples/data/ --fastq ../examples/complete/out/reads.fq --bam=../examples/complete/out/reads.bam -v


... and view it using `samtools tview` (We, of course, need `samtools` installed for this to work)

.. command-output::  samtools tview -d T -p "gi|4630864|dbj|AB026117.1|:6950" ../examples/complete/out/reads.bam ../examples/data/chimera.fa.gz

We can see one of the SNPs we put in!


Creating an alignment
---------------------
We can now use bwa to align the simulated reads (make sure you have generated the index for the reference):

.. command-output::  bwa mem -t 8 -p ../examples/data/chimera.fa.gz  ../examples/complete/out/reads.fq > ../examples/complete/out/test.sam
    :shell:

.. command-output::  samtools view -Sb  ../examples/complete/out/test.sam > ../examples/complete/out/temp.bam
    :shell:

.. command-output:: samtools sort ../examples/complete/out/temp.bam  ../examples/complete/out/test
.. command-output:: samtools index ../examples/complete/out/test.bam


And the check the alignment

.. command-output::  samtools tview -d T -p "gi|4630864|dbj|AB026117.1|:6950" ../examples/complete/out/test.bam ../examples/data/chimera.fa.gz

We can see one of the SNPs we put in!


Assessing alignment accuracy
----------------------------
The ``checkbam`` tool allows us to read in a ``.bam`` file generated by an aligner and check alignment accuracy provided
the original reads were produced by Mitty.

.. command-output:: checkbam  --inbam ../examples/complete/out/test.bam --out_prefix ../examples/complete/out/ -v

This is the ``.json`` file with a summary of alignment performance

.. command-output:: cat ../examples/complete/out/misalign.json


and this is the ``.csv`` file with details of how the reads were misaligned

.. command-output:: head -n 10 ../examples/complete/out/misalign.csv


Quick-start II
==============

TODO: Population simulations tutorial