

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating distributables &mdash; Mitty 1.1.1dev documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Mitty 1.1.1dev documentation" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> Mitty</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#installation">1.1. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#trivia">1.2. Trivia</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#creating-genomes">2.1. Creating genomes</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#taking-reads">2.2. Taking reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#testing-alignment-accuracy-of-bwa-mem">2.3. Testing alignment accuracy of BWA MEM</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#taking-reads-just-from-regions-around-variants">2.4. Taking reads just from regions around variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#analysing-variant-callers">2.5. Analysing variant callers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="additional_utils.html">3. Additional Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="additional_utils.html#plot-gc-bias-plot-gc-bias-of-a-bam-file">3.1. <cite>plot_gc_bias</cite>: Plot GC bias of a BAM file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="theory_and_algorithms.html">4. Theory and algorithms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="theory_and_algorithms.html#population-simulations">4.1. Population simulations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="models.html">5. Stock Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="models.html#variant-models">5.1. Variant models</a></li>
<li class="toctree-l2"><a class="reference internal" href="models.html#population-models">5.2. Population models</a></li>
<li class="toctree-l2"><a class="reference internal" href="models.html#read-models">5.3. Read models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ramblings.html">6. Ramblings AKA. Diary of a Developer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ramblings.html#simulating-a-million-genomes-in-python">6.1. Simulating a million Genomes in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="ramblings.html#report-generation">6.2. Report generation</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Mitty</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Creating distributables</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/temp.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="creating-distributables">
<h1>Creating distributables<a class="headerlink" href="#creating-distributables" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>sudo apt-get install python-dev  # Is common for a lot
sudo pip install wheel</p>
<p>sudo apt-get install zlib1g-dev  # This is needed for pysam</p>
<p>sudo apt-get install python-numpy  # This is much less painful than letting pip compile it
sudo apt-get install python-scipy  # This is much less painful than letting pip compile it</p>
</div></blockquote>
<div class="section" id="pysam">
<h2>pysam<a class="headerlink" href="#pysam" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>sudo apt-get install zlib1g-dev
git clone <a class="reference external" href="https://github.com/pysam-developers/pysam.git">https://github.com/pysam-developers/pysam.git</a>
sudo pip install .
pip wheel pysam</div></blockquote>
</div>
<div class="section" id="numpy">
<h2>numpy<a class="headerlink" href="#numpy" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>sudo apt-get install build-essential python-dev swig gfortran python-nose
download numpy source
BLAS=None LAPACK=None ATLAS=None python setup.py build
pip wheel numpy</div></blockquote>
</div>
<div class="section" id="handling-pyvcf">
<h2>Handling PyVCF<a class="headerlink" href="#handling-pyvcf" title="Permalink to this headline">¶</a></h2>
<p>The problem with PyVCF is that</p>
<p>Under <code class="docutils literal"><span class="pre">vcf/__init__.py</span></code> change VERSION to 0.7.0.</p>
<p><code class="docutils literal"><span class="pre">pip</span> <span class="pre">wheel</span> <span class="pre">.</span></code> copy this to the devpi server. Then require this in setup.py of Mitty</p>
</div>
<div class="section" id="de-novo-variant-collision-detection">
<h2>De Novo variant collision detection<a class="headerlink" href="#de-novo-variant-collision-detection" title="Permalink to this headline">¶</a></h2>
<p>When Mitty places de novo variants it prevents collisions with earlier variants by using a mask. I ended up going with
bitarray because it gave the best space/time tradeoff.</p>
</div>
<div class="section" id="speed-optimizing-denovo-py">
<h2>Speed optimizing denovo.py<a class="headerlink" href="#speed-optimizing-denovo-py" title="Permalink to this headline">¶</a></h2>
<p>Initially I was using scipy.sparse.lil_matrix for the collision mask, because I figured that this was the best way to economize on
space. I found, however, by simple profiling, that lil was taking what I considered to be a lot of time. I tried various other
sparse matrix types but lil was the fastest. I was especially bothered by the overhead of the lil __getitem__ call which
I thought was taking way too much cumulative time.</p>
<p>I was afraid to use regular arrays (regular numpy arrays gave a 5x speed up compared to sparse arrays) because I thought
this would not scale spacewise, because a whole genome simulation would take about 7 GB for the mask alone. Then I tried
bitarray. This turned out to be really fast though it does take some time during initialization.</p>
<p>Going from scipy.sparse to bitarray gave a 7x speed boost, knocking down execution time from 70s to 10s. Very interestingly,
when I replaced the <cite>Variant</cite> data type (which was a <cite>named_tuple</cite>) with a ctypes struct class the total time was knocked
down to 3s. I was shocked that a data type could be so inefficient, but it is used everywhere, and all the time, so
it is logical that any inefficiency here creates such a great effect.</p>
<p>So overall, for sprinkling about 130000 SNPs on chromosome 11, denovo.py went from 70s to 3s by some simple alterations.</p>
<div class="section" id="profile-results-chr11-130000-snps">
<h3>Profile results: chr11 130000 SNPs<a class="headerlink" href="#profile-results-chr11-130000-snps" title="Permalink to this headline">¶</a></h3>
<p>The following profile runs demonstrate why I ended up using <cite>bitarray</cite> for the collision detection mask</p>
<p>typical command line:</p>
<div class="highlight-python"><div class="highlight"><pre>python -m cProfile -o bitarray_stats.bin ../mitty/denovo.py  --wg ../examples/Human/Out/chr_11.h5  --vcf test.vcf.gz  --param_file ../examples/denovo/snp.json  --master_seed=1 -v
DEBUG:__main__:Reference file ../examples/Human/Out/chr_11.h5
DEBUG:mitty.Plugins.variants.snp_plugin:Used master seed to generate seeds 90950894, 39770206, 70599635, 88188254
DEBUG:__main__:131015 of 131131 variants placed
DEBUG:variation:Sorting /var/folders/s_/bhgzsrbj7cj220_s1cnpzgvm0000gn/T/tmpyenywa.vcf to test.vcf
DEBUG:variation:Compressing and indexing test.vcf to test.vcf.gz
</pre></div>
</div>
<p>sparse matrix:</p>
<div class="highlight-python"><div class="highlight"><pre>In [53]: p = pstats.Stats(&#39;sparsearray_stats.bin&#39;)
In [54]: p.strip_dirs().sort_stats(&#39;tottime&#39;).print_stats(30)
Thu Aug  7 08:11:20 2014    sparsearray_stats.bin

         49637097 function calls (49636390 primitive calls) in 73.646 seconds

   Ordered by: internal time
   List reduced from 1047 to 30 due to restriction &lt;30&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
   655126    7.340    0.000   18.639    0.000 stride_tricks.py:36(broadcast_arrays)
        1    6.791    6.791   65.445   65.445 denovo.py:120(arbitrate_variant_collisions)
   917388    5.115    0.000    8.444    0.000 stride_tricks.py:22(as_strided)
  3407329    4.716    0.000    4.716    0.000 {numpy.core.multiarray.array}
   458694    4.112    0.000   22.274    0.000 sputils.py:329(_index_to_arrays)
   262262    3.974    0.000    3.974    0.000 {scipy.sparse._csparsetools.lil_fancy_get}
   196432    2.690    0.000    2.690    0.000 {scipy.sparse._csparsetools.lil_fancy_set}
   917388    2.436    0.000    3.810    0.000 sputils.py:310(_check_boolean)
 10683970    2.344    0.000    2.644    0.000 {isinstance}
   458694    2.230    0.000    5.354    0.000 sputils.py:244(_unpack_index)
   262262    2.170    0.000   36.775    0.000 lil.py:228(__getitem__)
   196432    1.922    0.000   21.189    0.000 lil.py:270(__setitem__)
        3    1.759    0.586    1.759    0.586 {method &#39;rand&#39; of &#39;mtrand.RandomState&#39; objects}
   262263    1.759    0.000    8.985    0.000 lil.py:86(__init__)
  2948597    1.525    0.000    5.519    0.000 numeric.py:392(asarray)
   524526    1.453    0.000    2.280    0.000 fromnumeric.py:2412(ndim)
   524548    1.449    0.000    1.449    0.000 {numpy.core.multiarray.empty}
   458694    1.146    0.000    3.341    0.000 shape_base.py:8(atleast_1d)
   458694    0.956    0.000    0.956    0.000 {scipy.sparse._csparsetools.prepare_index_for_memoryview}
   262263    0.913    0.000    4.245    0.000 sputils.py:204(isshape)
   458694    0.867    0.000    0.867    0.000 {method &#39;reshape&#39; of &#39;numpy.ndarray&#39; objects}
   458694    0.815    0.000    0.861    0.000 sputils.py:272(_check_ellipsis)
  2489903    0.806    0.000    1.426    0.000 base.py:861(isspmatrix)
   458694    0.795    0.000    0.795    0.000 {numpy.core.multiarray.arange}
        1    0.789    0.789    0.789    0.789 {posix.waitpid}
7015738/7015606    0.696    0.000    0.696    0.000 {len}
   655075    0.599    0.000    0.599    0.000 collections.py:54(__setitem__)
   262263    0.575    0.000    0.607    0.000 lil.py:132(set_shape)
        2    0.562    0.281    3.391    1.695 snp_plugin.py:51(variant_generator)
   262262    0.551    0.000    0.690    0.000 lil.py:181(getnnz)
</pre></div>
</div>
<p>numpy array:</p>
<div class="highlight-python"><div class="highlight"><pre>In [51]: p = pstats.Stats(&#39;numpyarray_stats.bin&#39;)
In [52]: p.strip_dirs().sort_stats(&#39;tottime&#39;).print_stats(30)
Thu Aug  7 08:08:02 2014    numpyarray_stats.bin

         4222136 function calls (4221429 primitive calls) in 10.668 seconds

   Ordered by: internal time
   List reduced from 1015 to 30 due to restriction &lt;30&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    2.501    2.501    2.670    2.670 denovo.py:120(arbitrate_variant_collisions)
        3    1.764    0.588    1.764    0.588 {method &#39;rand&#39; of &#39;mtrand.RandomState&#39; objects}
        1    0.787    0.787    0.787    0.787 {posix.waitpid}
        2    0.575    0.288    3.407    1.704 snp_plugin.py:51(variant_generator)
   655075    0.566    0.000    0.566    0.000 collections.py:54(__setitem__)
        3    0.536    0.179    0.536    0.179 {method &#39;nonzero&#39; of &#39;numpy.ndarray&#39; objects}
   131015    0.509    0.000    1.550    0.000 _abcoll.py:526(update)
   131015    0.406    0.000    2.099    0.000 collections.py:38(__init__)
        1    0.364    0.364    3.377    3.377 variation.py:77(vcf_save)
        1    0.335    0.335    0.335    0.335 {method &#39;read&#39; of &#39;h5py.h5d.DatasetID&#39; objects}
   131015    0.221    0.000    2.375    0.000 &lt;string&gt;:24(_asdict)
   131193    0.202    0.000    0.202    0.000 {method &#39;format&#39; of &#39;str&#39; objects}
   131015    0.180    0.000    0.287    0.000 abc.py:128(__instancecheck__)
   262262    0.169    0.000    0.169    0.000 {numpy.core.multiarray.count_nonzero}
   393058    0.143    0.000    0.143    0.000 _weakrefset.py:70(__contains__)
        1    0.139    0.139    0.139    0.139 {pysam.ctabix.tabix_compress}
   131029    0.128    0.000    0.128    0.000 {map}
   262157    0.126    0.000    0.126    0.000 {built-in method __new__ of type object at 0x100183140}
   131020    0.121    0.000    0.121    0.000 {zip}
   131015    0.111    0.000    0.357    0.000 &lt;string&gt;:28(_replace)
   131057    0.084    0.000    0.084    0.000 {hasattr}
   131021    0.079    0.000    0.079    0.000 {method &#39;write&#39; of &#39;file&#39; objects}
131027/131026    0.076    0.000    0.133    0.000 abc.py:148(__subclasscheck__)
   132944    0.071    0.000    0.358    0.000 {isinstance}
   131015    0.064    0.000    0.117    0.000 &lt;string&gt;:12(_make)
      2/1    0.061    0.030   10.567   10.567 denovo.py:69(&lt;module&gt;)
        1    0.050    0.050    0.050    0.050 {pysam.ctabix.tabix_index}
528191/528059    0.042    0.000    0.042    0.000 {len}
   131131    0.040    0.000    0.125    0.000 &lt;string&gt;:8(__new__)
   131530    0.020    0.000    0.020    0.000 {getattr}
</pre></div>
</div>
<p>bitarray:</p>
<div class="highlight-python"><div class="highlight"><pre>In [55]: p = pstats.Stats(&#39;bitarray_stats.bin&#39;)
In [56]: p.strip_dirs().sort_stats(&#39;tottime&#39;).print_stats(30)
Thu Aug  7 08:16:50 2014    bitarray_stats.bin

         4222178 function calls (4221471 primitive calls) in 10.629 seconds

   Ordered by: internal time
   List reduced from 1015 to 30 due to restriction &lt;30&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        3    1.785    0.595    1.785    0.595 {method &#39;rand&#39; of &#39;mtrand.RandomState&#39; objects}
        1    1.775    1.775    1.793    1.793 denovo.py:123(arbitrate_variant_collisions)
        1    0.787    0.787    0.787    0.787 {posix.waitpid}
        1    0.662    0.662    0.662    0.662 denovo.py:85(initialize_mask)
   655075    0.593    0.000    0.593    0.000 collections.py:54(__setitem__)
        2    0.578    0.289    3.406    1.703 snp_plugin.py:51(variant_generator)
   131015    0.533    0.000    1.622    0.000 _abcoll.py:526(update)
        3    0.524    0.175    0.524    0.175 {method &#39;nonzero&#39; of &#39;numpy.ndarray&#39; objects}
   131015    0.438    0.000    2.206    0.000 collections.py:38(__init__)
        1    0.387    0.387    3.561    3.561 variation.py:77(vcf_save)
        1    0.336    0.336    0.336    0.336 {method &#39;read&#39; of &#39;h5py.h5d.DatasetID&#39; objects}
   131015    0.236    0.000    2.500    0.000 &lt;string&gt;:24(_asdict)
   131194    0.218    0.000    0.218    0.000 {method &#39;format&#39; of &#39;str&#39; objects}
   131015    0.188    0.000    0.298    0.000 abc.py:128(__instancecheck__)
   393058    0.147    0.000    0.147    0.000 _weakrefset.py:70(__contains__)
        1    0.145    0.145    0.145    0.145 {pysam.ctabix.tabix_compress}
   131029    0.135    0.000    0.135    0.000 {map}
   131015    0.119    0.000    0.374    0.000 &lt;string&gt;:28(_replace)
   131020    0.119    0.000    0.119    0.000 {zip}
   262157    0.118    0.000    0.118    0.000 {built-in method __new__ of type object at 0x100183140}
   131057    0.089    0.000    0.089    0.000 {hasattr}
   131021    0.082    0.000    0.082    0.000 {method &#39;write&#39; of &#39;file&#39; objects}
131027/131026    0.078    0.000    0.137    0.000 abc.py:148(__subclasscheck__)
   132950    0.075    0.000    0.373    0.000 {isinstance}
   131015    0.067    0.000    0.120    0.000 &lt;string&gt;:12(_make)
      2/1    0.062    0.031   10.532   10.532 denovo.py:69(&lt;module&gt;)
        1    0.052    0.052    0.052    0.052 {pysam.ctabix.tabix_index}
528191/528059    0.042    0.000    0.042    0.000 {len}
   131131    0.039    0.000    0.116    0.000 &lt;string&gt;:8(__new__)
   131530    0.022    0.000    0.022    0.000 {getattr}
</pre></div>
</div>
<p>bitarray with ctypes class for Variation:</p>
<div class="highlight-python"><div class="highlight"><pre>In [45]: p = pstats.Stats(&#39;bitarray_stats.bin&#39;)
In [46]: p.strip_dirs().sort_stats(&#39;tottime&#39;).print_stats(30)
Fri Aug  8 06:18:49 2014    bitarray_stats.bin

         420785 function calls (420089 primitive calls) in 3.633 seconds

   Ordered by: internal time
   List reduced from 923 to 30 due to restriction &lt;30&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.884    0.884    0.884    0.884 {posix.waitpid}
        1    0.657    0.657    0.659    0.659 denovo.py:84(initialize_mask)
        2    0.594    0.297    1.098    0.549 snp_plugin.py:51(variant_generator)
        1    0.415    0.415    0.415    0.415 {method &#39;read&#39; of &#39;h5py.h5d.DatasetID&#39; objects}
        1    0.289    0.289    0.306    0.306 denovo.py:114(arbitrate_variant_collisions)
        1    0.178    0.178    0.235    0.235 variation.py:103(vcf_save)
        1    0.147    0.147    0.147    0.147 {pysam.ctabix.tabix_compress}
        1    0.069    0.069    0.069    0.069 {pysam.ctabix.tabix_index}
        5    0.064    0.013    0.064    0.013 {zip}
   131115    0.057    0.000    0.057    0.000 {method &#39;write&#39; of &#39;file&#39; objects}
      2/1    0.055    0.027    3.541    3.541 denovo.py:69(&lt;module&gt;)
        3    0.021    0.007    0.021    0.007 {open}
   262218    0.017    0.000    0.017    0.000 {method &#39;any&#39; of &#39;bitarray._bitarray&#39; objects}
        1    0.015    0.015    0.015    0.015 {method &#39;poisson&#39; of &#39;mtrand.RandomState&#39; objects}
        3    0.014    0.005    0.087    0.029 __init__.py:10(&lt;module&gt;)
        1    0.010    0.010    1.415    1.415 denovo.py:150(add_variant_model_to_genome)
        9    0.010    0.001    0.058    0.006 __init__.py:1(&lt;module&gt;)
        2    0.006    0.003    0.006    0.003 {method &#39;read&#39; of &#39;file&#39; objects}
        1    0.005    0.005    0.006    0.006 __init__.py:88(&lt;module&gt;)
        2    0.005    0.002    0.006    0.003 {__import__}
        1    0.004    0.004    3.451    3.451 denovo.py:195(main)
      273    0.003    0.000    0.004    0.000 function_base.py:2945(add_newdoc)
        2    0.003    0.002    0.034    0.017 variation.py:6(&lt;module&gt;)
        1    0.003    0.003    0.004    0.004 polynomial.py:55(&lt;module&gt;)
        5    0.003    0.001    0.004    0.001 collections.py:288(namedtuple)
        7    0.003    0.000    0.003    0.000 {method &#39;sub&#39; of &#39;_sre.SRE_Pattern&#39; objects}
   114/42    0.003    0.000    0.007    0.000 sre_parse.py:379(_parse)
        1    0.002    0.002    0.003    0.003 hermite.py:59(&lt;module&gt;)
        1    0.002    0.002    0.007    0.007 util.py:11(zygosity)
        1    0.002    0.002    0.003    0.003 laguerre.py:59(&lt;module&gt;)
</pre></div>
</div>
</div>
</div>
<div class="section" id="mutate-py">
<h2>mutate.py<a class="headerlink" href="#mutate-py" title="Permalink to this headline">¶</a></h2>
<p>Internally, Mitty stores each variant as a group of operations</p>
<p>(type, zygosity, footprint)
()</p>
<p>The reference is assumed to be haploid (we always use copy 1)</p>
<p>Mitty stores the actual generated variant in a systematic format in a hdf5 file. Conceptually, each variant is stored
as follows:</p>
<blockquote>
<div><blockquote>
<div>_ type name</div></blockquote>
<p>/</p>
</div></blockquote>
<dl class="docutils">
<dt>(type, zygosity, footprint, )</dt>
<dd><dl class="first last docutils">
<dt>           </dt>
<dd><dl class="first last docutils">
<dt>           _ list of variant description tuples</dt>
<dd><dl class="first last docutils">
<dt></dt>
<dd>0 -&gt; no variant (due to arbitration, see below)
1 -&gt; variant on copy 1
2 -&gt; variant on copy 2
3 -&gt; variant on both copies</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>Most commonly, there is only one element in the list of variant descriptions and this corresponds exactly with a VCF
file entry. Complicated variants are expressed as a sequence of insertions and deletions.</p>
<p>Each variant model returns a variant file of proposed variants in this format. Mitty then arbitrates between all the
variants to make sure they don&#8217;t clash.</p>
<p>Variant types:</p>
<p>SNP             - footprint is 1
Insert          - footprint is 0
Delete          - footprint is N
Inversion       - footprint is N
Repeat          - footprint is N
Translocation   - foorprint is N</p>
<p>Mitty writes out variants in VCF format (using the variant2vcf tool).</p>
<p>Each model should have a .variant method that is passed the reference genome data and any general and specific
parameters it needs. Each model&#8217;s .variant method is called in turn and it fills out the variant data structure
(on an hdf5 file, due to the potential size of the data) and returns it to mutate.py</p>
<p>mutate.py is responsible for arbitrating between variants that clash by using a genome-wide mask.</p>
</div>
<div class="section" id="passing-whole-genome-file-to-mutation-plugins">
<h2>Passing whole genome file to mutation plugins<a class="headerlink" href="#passing-whole-genome-file-to-mutation-plugins" title="Permalink to this headline">¶</a></h2>
<p>This allows plugins to do non-local things, like translocations, which they would not be able to do if they only recieved
a sequence.</p>
</div>
<div class="section" id="choice-to-output-a-mutated-sequence-as-a-whole">
<h2>Choice to output a mutated sequence as a whole<a class="headerlink" href="#choice-to-output-a-mutated-sequence-as-a-whole" title="Permalink to this headline">¶</a></h2>
<p>VCF files (especially with the literal phase information as used by Mitty) form a complete description of a genome (in the form of diffs to the reference, haploid, sequences). However, for the purposes of taking reads the whole mutated genome is written out explicitly. I chose this approach as it ended up being simpler than implementing an algorithm for generating reads on the fly based on a VCF file. In the future the code may be modified to do on the fly generation.</p>
</div>
<div class="section" id="random-number-seeds">
<h2>Random number seeds<a class="headerlink" href="#random-number-seeds" title="Permalink to this headline">¶</a></h2>
<p>All stock plugins employ explicit random number seeds. Random number generators for different parameters of the simulation are decoupled (independent) from each other and each takes its own seed (Though all plugins can take a single master seed which they use to generate the required number of individual seeds). This is an important design choice that allows exact reproducibility of simulations and allows us to avoid couplings between parameters which might otherwise crop up if the same random number generator was used for all the simulation variables.</p>
</div>
<div class="section" id="vcf2seq-why-we-store-vcf-details">
<h2>vcf2seq - why we store VCF details<a class="headerlink" href="#vcf2seq-why-we-store-vcf-details" title="Permalink to this headline">¶</a></h2>
<p>In some use cases <a class="footnote-reference" href="#localreads" id="id1">[1]</a> we need to know which parts of the mutated genome are mutated. For this reason we store the positions of mutations (in <cite>/variants/pos/</cite>) and the details of the variant (<cite>/variants/codes/</cite>).</p>
<table class="docutils footnote" frame="void" id="localreads" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The <cite>reads.py</cite> program&#8217;s <cite>localreads</cite> option uses this, for example, to generate reads from only the insertions.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>Running all tests:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">nosetests</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
<p>Including the few doctests there are:</p>
<div class="highlight-python"><div class="highlight"><pre>nosetests mitty --with-doctest -v
</pre></div>
</div>
<p>Including specific doctests:</p>
<div class="highlight-python"><div class="highlight"><pre>nosetests mitty/Plugins/Mutation --with-doctest -v
</pre></div>
</div>
<p>Running specific tests:</p>
<div class="highlight-python"><div class="highlight"><pre>nosetests tests.vcf2seq_test:test_assemble_sequences_hetero_same_locus_del -v
</pre></div>
</div>
<p>Running with coverage:</p>
<div class="highlight-python"><div class="highlight"><pre>nosetests --with-coverage --cover-package=mitty
</pre></div>
</div>
</div>
<div class="section" id="profiling-the-code">
<h2>Profiling the code<a class="headerlink" href="#profiling-the-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre>python -m cProfile -o denovostats.bin ../mitty/denovo.py  --wg ../examples/mutate/Out/chimera.h5  --vcf test.vcf.gz  --param_file ../examples/denovo/snp.json -v --master_seed=1

import pstats
p = pstats.Stats(&#39;denovostats.bin&#39;)
p.strip_dirs().sort_stats(&#39;cumulative&#39;).print_stats(10)
</pre></div>
</div>
</div>
<div class="section" id="generating-documentation">
<h2>Generating documentation<a class="headerlink" href="#generating-documentation" title="Permalink to this headline">¶</a></h2>
<p><cite>sphinx-apidoc mitty/ -o docs</cite> from the root directory</p>
<p>Notes:</p>
<ol class="arabic simple">
<li>There are several example shell scripts and parameter files under the <cite>examples</cite> directory</li>
</ol>
<p>2) Each script has detailed help information that can be accessed using the <cite>-h</cite> option or by simply calling the script
with no options</p>
</div>
<div class="section" id="population">
<h2>Population<a class="headerlink" href="#population" title="Permalink to this headline">¶</a></h2>
<p>Roadmap:</p>
<ul class="simple">
<li>Rework crossover model to match that in text book (current model does not correctly reflect effects on copies</li>
<li>[DONE] Load reference only once and keep in memory - perhaps give warnings if genome too big for machine and fallback to a</li>
</ul>
<blockquote>
<div>slower load on demand model. This may mean writing a new class to handle genomes (like we did for variants)</div></blockquote>
<ul class="simple">
<li>[DONE] Don&#8217;t keep population in memory - save as we go and remove to keep memory consumption low and to have partial</li>
</ul>
<blockquote>
<div>results in case of an abort.</div></blockquote>
<ul class="simple">
<li>Finalize .json format for lineage and save that every generation</li>
<li>[DONE] Profile after optimizing reference loading - if needed get rid of bit mask and use a sorted list for genomes -</li>
</ul>
<p>implement collision detection based on the sorted vcf - this may be slightly slower than a bit mask, or may be not, if
we have to repeatedly instantiate masks. This will certainly use less memory</p>
<p>The internal structure of an attached pair of chromosomes is a list of tuples of the form:</p>
<p>(start, stop, REF, ALT, zygosity)</p>
<p>The module implements the following useful population functions and their supporting functions</p>
<p>crossover(g1, rng, params) -&gt; g2  simulating cross over between copies of chromosomes
fertilization(g1, g2, rng)   -&gt; g3  simulating creation of a child from parents
denovo(g1, ref, rng, params)  -&gt; g3  the only function that requires the original seq - generates denovo mutations</p>
<p>The module implements and uses the following utility functions</p>
<p>parse_vcf(vcf_reader)  -&gt; g1 read in a VCF file and convert it to out haploid genome format
vcf2chrom(vcf_reader)  -&gt; c1 read in one chromosome from a VCF file
write_to_vcf(fname, g1) write the data to a compressed, indexed VCF file</p>
<p>Internally, the only operation that violates sorting order is denovo, so this uses a blist.sortedlist. For everything
else we use a plain Python list as we only append items (and that is O(1) for a list)</p>
<p>get_rngs(seed)  -&gt;  rng  return a list of random number generators that are used by the different functions</p>
<p>The internal genome format is a simple list of tuples almost corresponding to the VCF</p>
<p>(start, stop, REF, ALT)</p>
<p>The following worker functions operate on single copies of chromosomes</p>
<dl class="docutils">
<dt>merge(c1, c2) -&gt; c3  merge the descriptions of the two chromosomes</dt>
<dd><blockquote class="first">
<div>This figures out any zygosity mutations. The output is sorted and is of the VCF format</div></blockquote>
<p class="last">(POS, POS1, REF, ALT, HET) We only need this when saving back to VCF</p>
</dd>
</dl>
<p>Though we could have written a class called genome, I prefer to write in as functional a style as possible for better
code quality.</p>
</div>
<div class="section" id="vcf2reads">
<h2>vcf2reads<a class="headerlink" href="#vcf2reads" title="Permalink to this headline">¶</a></h2>
<p>Note:
Expanding the variant sequence takes a bunch of memory because we need 14 bytes per base:</p>
<p>1 byte - forward seq
1 byte - complement seq
4 bytes - pos array  (needed for POS)
4 bytes - diff pos array (needed for CIGAR)
4 bytes - offset array (needed for offset for reads deep in inserts)
-
14 bytes</p>
<p>For this reason we adopt a just in time expansion where by we feed chunks of the variant sequence to the read plugin.
The smaller the chunk size the less extra memory is needed but the chunk computation has an overhead. In general, you
should make the chunk size as large as you can given your memory keeping in mind that each base takes 14 bytes of space
when the variant sequence is expanded.</p>
<p>Algorithm:</p>
<ol class="arabic">
<li><p class="first">Read plugin gives us a list of read + template positions (sorted by position along the mutated sequence).</p>
</li>
<li><p class="first">We start at the beginning of the reference sequence</p>
</li>
<li><p class="first">The read reference is the reference sequence</p>
</li>
<li><p class="first">If the template end is before the next variant position:
1. take reads, repeat 4.</p>
</li>
<li><p class="first">If the template end crosses the next variant position:
1. If read reference is the reference sequence, start an alt sequence,</p>
<blockquote>
<div><p>otherwise clip existing alt sequence (and pos_array)</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Expand the variant, add it to alt seq</li>
<li>Repeat 2 as needed to go past template</li>
<li>Goto 4</li>
</ol>
</li>
<li><p class="first">Repeat all this until reads are exhausted</p>
</li>
</ol>
<p>Roadmap</p>
<ol class="arabic simple">
<li>Rewrite to use only reference and VCF file to generate reads</li>
<li>Think about how to separate out plugin from main code etc.</li>
<li>Make corruption plugin, read plugin separate?</li>
</ol>
<ol class="arabic simple">
<li>The quality scores are in Phred scale (as specified in the SAM spec)</li>
<li>We supply the prefix of output file name in the parameter file . Say we set this as sim_reads.
The perfect reads will be saved to sim_reads.bam (or sim_reads.fastq). If we ask for corrupted reads
we will get the corrupted reads in the file sim_reads_c.fastq.
A text sidecar file sim_reads.info will always be saved with simulation parameters.</li>
</ol>
<dl class="docutils">
<dt>3 <a href="#id2"><span class="problematic" id="id3">**</span></a>* Can probably refactor the whole file for better readability **</dt>
<dd><strong>* see if we can write shorter functions, see if we can reduce the number of parameters/bundle them *</strong>
<strong>* further efficiency gains will probably be minimal - the bottle neck function has been cythonized *</strong></dd>
</dl>
</div>
<div class="section" id="generating-mutations">
<h2>Generating mutations<a class="headerlink" href="#generating-mutations" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="read-the-docs">
<h1>Read the docs<a class="headerlink" href="#read-the-docs" title="Permalink to this headline">¶</a></h1>
<p>For further details both on how to use Mitty as well as how to extend it for your custom uses please read the documents.</p>
<p>The program <cite>denovo.py</cite> makes use of variant plugins to sprinkle variants on the reference genome and produce a VCF file
that corresponds to a sample.</p>
<p>Mitty can generate VCF files that indicate mutations with respect to a reference genome. This is done via</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div>mutation</div></blockquote>
<dl class="docutils">
<dt>parameters</dt>
<dd><blockquote class="first last">
<div><div class="line-block">
<div class="line"><br /></div>
</div>
<p>V</p>
</div></blockquote>
</dd>
</dl>
<div class="line-block">
<div class="line"><a href="#id4"><span class="problematic" id="id5">|</span></a>&#8212;-&gt; VCF, VCF.gz, VCF.gz.tbi</div>
</div>
</div></blockquote>
<dl class="docutils">
<dt>ref seq &#8212;&gt;| mutate |</dt>
<dd><div class="first last line-block">
<div class="line"><a href="#id6"><span class="problematic" id="id7">|</span></a>&#8212;-&gt; side car file with sim params
&#8212;&#8212;&#8211;</div>
</div>
</dd>
</dl>
</div></blockquote>
<p>Given a set of mutation instructions we can use <cite>mutate.py</cite> to generate a VCF file. For further processing <cite>mutate.py</cite>
compresses the VCF file using <cite>bgzip</cite> and indexes it using <cite>tabix</cite>.</p>
<blockquote>
<div><blockquote>
<div></div></blockquote>
<dl class="docutils">
<dt>ref seq &#8212;&gt;|         <a href="#id8"><span class="problematic" id="id9">|</span></a>&#8212;&gt; seq_0, seq_1, ... (depending on requested ploidy)</dt>
<dd><div class="first last line-block">
<div class="line">vcf2seq |</div>
</div>
</dd>
<dt>VCF.gz  &#8212;&gt;|         <a href="#id10"><span class="problematic" id="id11">|</span></a>&#8212;&gt; pos file</dt>
<dd></dd>
</dl>
</div></blockquote>
<p>Using the <cite>vcf2seq</cite> tool we can write out the mutations indicated by VCF into a complete mutated sequence saved as a
set of .smalla files. The number of .smalla files depends on the ploidy we request.
We also save a <cite>pos</cite> file which is used by <cite>reads.py</cite> (see below) for writing correct CIGAR strings for each read.</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div>read</div></blockquote>
<dl class="docutils">
<dt>parameters</dt>
<dd><div class="first line-block">
<div class="line"><br /></div>
</div>
<p class="last">V</p>
</dd>
</dl>
</div></blockquote>
<p>seq_0     &#8212;&#8212;&#8211;
seq_1    |        <a href="#id12"><span class="problematic" id="id13">|</span></a>&#8212;-&gt; corrupted (&#8220;real&#8221;) reads (BAM/FASTQ) if requested.</p>
<blockquote>
<div><dl class="docutils">
<dt>... &#8212;&gt;|        |</dt>
<dd><div class="first last line-block">
<div class="line">reads  <a href="#id14"><span class="problematic" id="id15">|</span></a>&#8212;-&gt; ideal reads (BAM/FASTQ)</div>
</div>
</dd>
</dl>
</div></blockquote>
<p>pos_0 &#8211;&gt;|        |
pos_1    |        <a href="#id16"><span class="problematic" id="id17">|</span></a>&#8212;-&gt; side car file with sim params</p>
<blockquote>
<div>...      &#8212;&#8212;&#8211;</div></blockquote>
</div></blockquote>
<dl class="docutils">
<dt>The <cite>reads</cite> tool enables us to take a sequence and generate simulated reads from it. The reads can</dt>
<dd><p class="first">simulate various error and property profiles of different sequencers. Each read carries, in its qname field,
a read serial number and POS and CIGAR strings that can be used to recreate perfect alignments of the reads to
the original reference. This information is useful for diagnosing the performance of aligners and variant
callers.</p>
<blockquote class="last">
<div><blockquote>
<div><blockquote>
<div></div></blockquote>
<div class="line-block">
<div class="line"><a href="#id18"><span class="problematic" id="id19">|</span></a></div>
</div>
</div></blockquote>
<dl class="docutils">
<dt>BAM  &#8212;&gt;|  cheata  <a href="#id20"><span class="problematic" id="id21">|</span></a>&#8212;&gt; BAM file with perfect alignments</dt>
<dd><div class="first last line-block">
<div class="line">|
&#8212;&#8212;&#8212;-</div>
</div>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
<p>The <cite>cheata</cite> tool takes a simulated BAM file generated by <cite>reads.py</cite> and uses the POS and CIGAR information stored in
the qname field to generate a perfectly aligned BAM file.</p>
</div>
<div class="section" id="de-novo-variation-parameter-file">
<h1>De Novo Variation parameter file<a class="headerlink" href="#de-novo-variation-parameter-file" title="Permalink to this headline">¶</a></h1>
<p>The format is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;variant_models&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="c"># The order in which we place models indicates their priority</span>
        <span class="p">{</span>
            <span class="s">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;param1&quot;</span><span class="p">:</span> <span class="n">v1</span><span class="p">,</span>
                <span class="s">&quot;param2&quot;</span><span class="p">:</span> <span class="n">v2</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">{</span>   <span class="c"># We can repeat a model</span>
                <span class="s">&quot;param1&quot;</span><span class="p">:</span> <span class="n">v1</span><span class="p">,</span>
                <span class="s">&quot;param2&quot;</span><span class="p">:</span> <span class="n">v2</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>


<span class="p">{</span>
    <span class="s">&quot;variant_models&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s">&quot;snp&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="s">&quot;base_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s">&quot;base_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s">&quot;copy_rng_seed&quot;</span><span class="p">:</span> <span class="mi">4</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s">&quot;snp&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span>
                <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
                <span class="s">&quot;poisson_rng_seed&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s">&quot;base_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="s">&quot;copy_rng_seed&quot;</span><span class="p">:</span> <span class="mi">8</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s">&quot;insert&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
                <span class="s">&quot;ins_len_lo&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s">&quot;ins_len_hi&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s">&quot;ins_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                <span class="s">&quot;ins_len_rng_seed&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s">&quot;base_sel_rng_seed&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s">&quot;copy_rng_seed&quot;</span><span class="p">:</span> <span class="mi">13</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span>
            <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
            <span class="s">&quot;del_len_lo&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s">&quot;del_len_hi&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s">&quot;del_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s">&quot;del_len_rng_seed&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s">&quot;copy_rng_seed&quot;</span><span class="p">:</span> <span class="mi">17</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;inversion&quot;</span><span class="p">,</span>
            <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
            <span class="s">&quot;inv_len_lo&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s">&quot;inv_len_hi&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s">&quot;inv_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
            <span class="s">&quot;inv_len_rng_seed&quot;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
            <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s">&quot;copy_rng_seed&quot;</span><span class="p">:</span> <span class="mi">21</span>
        <span class="p">}</span>

    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mitty-on-the-commandline">
<h1>Mitty on the commandline<a class="headerlink" href="#mitty-on-the-commandline" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="generating-simulated-variations">
<h1>Generating simulated variations<a class="headerlink" href="#generating-simulated-variations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="converta">
<h2>Converta<a class="headerlink" href="#converta" title="Permalink to this headline">¶</a></h2>
<p>We use converta to reorganize sequence data in .fasta files so that Mitty&#8217;s routines can use them. (Dev note: basically,
by stripping out the header and newlines from the .fasta file the .smalla file can be easily used as a disk mapped
array - via mmap - so we can handle large sequences without loading it into memory all at once)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python converta.py Data/porcine_circovirus.fa README-DATA/porcine_circovirus&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/porcine_circovirus_0.smalla&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="go">ATGACGTATCCAAGGAGGCGTTACCGGAGAAGAAGACACCGCCCCCGCAGCCATCTTGGCCAGATCCTCCGCCGCCGCCCCTGGCTCGTCCACCCCCGCCACCGTTACCGCTGGAGAAGGAAAAACGGCATCTTCAACACCCGCCTCTCCCGCACCTTCGGATATACTATCAAGCGAACCACAGTCAAAACGCCCTCCTGGGCGGTGGACATGATGAGATTCAATATTAATGACTTTCTTCCCCCAGGAGGGGGCTCAAACCCCCGCTCTGTGCCCTTTGAATACTACAGAATAAGAAAGGTTAAGGTTGAATTCTGGCCCTGCTCCCCGATCACCCAGGGTGACAGGGGAGTGGGCTCCAGTGCTGTTATTCTAGATGATAACTTTGTAACAAAGGCCACAGCCCTCACCTATGACCCCTATGTAAACTACTCCTCCCGCCATACCATAACCCAGCCCTTCTCCTACCACTCCCGCTACTTTACCCCCAAACCTGTCCTAGATTCCACTATTGATTACTTCCAACCAAACAACAAAAGAAATCAGCTGTGGCTGAGACTACAAACTGCTGGAAATGTAGACCACGTAGGCCTCGGCACTGCGTTCGAAAACAGTATATACGACCAGGAATACAATATCCGTGTAACCATGTATGTACAATTCAGAGAATTTAATCTTAAAGACCCCCCACTTAACCCTTAG</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/porcine_circovirus_0.smalla.heada&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="go">gi|52547303|gb|AY735451.1| Porcine circovirus isolate Hebei capsid protein gene, complete cds</span>
<span class="go">702</span>
</pre></div>
</div>
</div>
<div class="section" id="mutate">
<h2>Mutate<a class="headerlink" href="#mutate" title="Permalink to this headline">¶</a></h2>
<p>We use mutate, in combination with a mutation parameter file, to generate a VCF file. The <cite>-v</cite> flag causes <cite>mutate.py</cite> to
give a running commentary as it works, which is useful to see if everything is going well.</p>
<p>We will start with a simple experiment where we insert a few SNPs into the porcine circovirus sequence</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">json</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>     <span class="s">&quot;input smalla file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/porcine_circovirus_0.smalla&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;output vcf file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/variants.vcf&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;mutations&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>         <span class="s">&quot;snp&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>             <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;start_snps_frac&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;stop_snps_frac&quot;</span><span class="p">:</span>  <span class="mf">0.3</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;het_rng_seed&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;strand_rng_seed&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;poisson_rng_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;base_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="gp">... </span>         <span class="p">}</span>
<span class="gp">... </span>     <span class="p">}</span>
<span class="gp">... </span> <span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/mutations1.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python mutate.py --paramfile=README-DATA/mutations1.json  -v&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>(For a detailed description of the stock plugin parameters you can run the plugin as a script with the <cite>explain</cite> command,
e.g. <cite>python Plugins/Mutation/insert_plugin.py explain</cite>).</p>
<p>You should see something like:</p>
<blockquote>
<div>DEBUG:__main__:Input sequence: README-DATA/porcine_circovirus_0.smalla
DEBUG:__main__:Input sequence has 702 bases
DEBUG:__main__:Output file name: README-DATA/variants.vcf
DEBUG:__main__:100% done
DEBUG:__main__:Generated 1 snps
DEBUG:__main__:Compressing and indexing VCF file</div></blockquote>
<p>You can take a look at the generated VCF file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/variants.vcf&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
<span class="go">##fileformat=VCFv4.1</span>
<span class="go">##fileDate=...</span>
<span class="go">##source=...</span>
<span class="go">##reference=porcine_circovirus_0.smalla</span>
<span class="go">#CHROM      POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  sample</span>
<span class="go">1   169     .       A       T       96      PASS    .       GT      1/1</span>
</pre></div>
</div>
<p>Mutate is smart enough not to overlay multiple variants. Consider the following parameter file that generates SNPs
uniformly across the sequence</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>     <span class="s">&quot;input smalla file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/porcine_circovirus_0.smalla&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;output vcf file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/variants.vcf&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;mutations&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>         <span class="s">&quot;snp&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>             <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;start_snps_frac&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;stop_snps_frac&quot;</span><span class="p">:</span>  <span class="mf">1.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;poisson_rng_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;base_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="gp">... </span>         <span class="p">}</span>
<span class="gp">... </span>     <span class="p">}</span>
<span class="gp">... </span> <span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/mutations2.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>(Note that you can leave out parameters. In general, programs in Mitty will fill out missing parameters with defaults. In
this case we left out the <cite>het_rng_seed</cite> but <cite>phet=0.0</cite> means that we don&#8217;t need that anyway.)</p>
<p>Let&#8217;s take a look at the resulting VCF file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python mutate.py --paramfile=README-DATA/mutations2.json&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/variants.vcf&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
<span class="go">##fileformat=VCFv4.1</span>
<span class="go">##fileDate=...</span>
<span class="go">##source=...</span>
<span class="go">##reference=porcine_circovirus_0.smalla</span>
<span class="go">#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  sample</span>
<span class="go">1       99      .       C       G       96      PASS    .       GT      1/1</span>
<span class="go">1       187     .       A       C       96      PASS    .       GT      1/1</span>
<span class="go">1       277     .       T       C       96      PASS    .       GT      1/1</span>
<span class="go">1       374     .       T       A       96      PASS    .       GT      1/1</span>
<span class="go">1       472     .       T       A       96      PASS    .       GT      1/1</span>
<span class="go">1       570     .       T       C       96      PASS    .       GT      1/1</span>
<span class="go">1       657     .       A       G       96      PASS    .       GT      1/1</span>
</pre></div>
</div>
<p>Consider the following parameter file that generates deletes uniformly across the sequence</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>     <span class="s">&quot;input smalla file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/porcine_circovirus_0.smalla&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;output vcf file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/variants.vcf&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;mutations&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>         <span class="s">&quot;delete&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>             <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;start_dels_frac&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;stop_dels_frac&quot;</span><span class="p">:</span>  <span class="mf">1.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;p_del&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;lam_del&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;del_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;del_len_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">4</span>
<span class="gp">... </span>         <span class="p">}</span>
<span class="gp">... </span>     <span class="p">}</span>
<span class="gp">... </span> <span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/mutations3.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s take a look at the resulting VCF file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python mutate.py --paramfile=README-DATA/mutations3.json&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/variants.vcf&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
<span class="go">##fileformat=VCFv4.1</span>
<span class="go">##fileDate=...</span>
<span class="go">##source=...</span>
<span class="go">##reference=porcine_circovirus_0.smalla</span>
<span class="go">#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  sample</span>
<span class="go">1       102     .       CCGTTACCGC      C       96      PASS    .       GT      1/1</span>
<span class="go">1       196     .       TCCTGGG T       96      PASS    .       GT      1/1</span>
<span class="go">1       283     .       TACTACAG        T       96      PASS    .       GT      1/1</span>
<span class="go">1       361     .       AGTGCTGTTA      A       96      PASS    .       GT      1/1</span>
<span class="go">1       465     .       CTACCACTCC      C       96      PASS    .       GT      1/1</span>
<span class="go">1       570     .       TGGAAATGTA      T       96      PASS    .       GT      1/1</span>
<span class="go">1       663     .       CAGAGAA C       96      PASS    .       GT      1/1</span>
</pre></div>
</div>
<p>If we put these two sets of mutations together, we can see that the SNP at 374 would overlap with the delete starting at
361 and the SNP at 472 would come right after the delete at 465. The SNP at 570 would come right before the delete at
570. For purposes of clarity (see below) we like to have at least a one base gap between mutations.</p>
<p>When we ask <cite>mutate.py</cite> for both these sets of mutations (keeping the same random seeds),</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>     <span class="s">&quot;input smalla file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/porcine_circovirus_0.smalla&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;output vcf file&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/variants.vcf&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;chromosome&quot;</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="s">&quot;mutations&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>         <span class="s">&quot;snp&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>             <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;start_snps_frac&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;stop_snps_frac&quot;</span><span class="p">:</span>  <span class="mf">1.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;poisson_rng_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;base_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="gp">... </span>         <span class="p">},</span>
<span class="gp">... </span>         <span class="s">&quot;delete&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>             <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;start_dels_frac&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;stop_dels_frac&quot;</span><span class="p">:</span>  <span class="mf">1.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;phet&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;p_del&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;lam_del&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;del_loc_rng_seed&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>             <span class="s">&quot;del_len_sub_rng_seed&quot;</span><span class="p">:</span> <span class="mi">4</span>
<span class="gp">... </span>         <span class="p">}</span>
<span class="gp">... </span>     <span class="p">}</span>
<span class="gp">... </span> <span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/mutations4.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>we get:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python mutate.py --paramfile=README-DATA/mutations4.json&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/variants.vcf&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
<span class="go">##fileformat=VCFv4.1</span>
<span class="go">##fileDate=...</span>
<span class="go">##source=...</span>
<span class="go">##reference=porcine_circovirus_0.smalla</span>
<span class="go">#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  sample</span>
<span class="go">1       99      .       C       G       96      PASS    .       GT      1/1</span>
<span class="go">1       102     .       CCGTTACCGC      C       96      PASS    .       GT      1/1</span>
<span class="go">1       187     .       A       C       96      PASS    .       GT      1/1</span>
<span class="go">1       196     .       TCCTGGG T       96      PASS    .       GT      1/1</span>
<span class="go">1       277     .       T       C       96      PASS    .       GT      1/1</span>
<span class="go">1       283     .       TACTACAG        T       96      PASS    .       GT      1/1</span>
<span class="go">1       361     .       AGTGCTGTTA      A       96      PASS    .       GT      1/1</span>
<span class="go">1       374     .       T       A       96      PASS    .       GT      1/1</span>
<span class="go">1       465     .       CTACCACTCC      C       96      PASS    .       GT      1/1</span>
<span class="go">1       570     .       T       C       96      PASS    .       GT      1/1</span>
<span class="go">1       657     .       A       G       96      PASS    .       GT      1/1</span>
<span class="go">1       663     .       CAGAGAA C       96      PASS    .       GT      1/1</span>
</pre></div>
</div>
<p>Mutate resolves the conflicts between the mutations and ensures they don&#8217;t clash.</p>
<p>Also note that we&#8217;ve kept all our random number generators independent. This allows us greater control over the data
we generate and allows us to avoid unexpected interactions between all our variables.</p>
</div>
</div>
<div class="section" id="generating-reads">
<h1>Generating reads<a class="headerlink" href="#generating-reads" title="Permalink to this headline">¶</a></h1>
<p>In the previous section we learned how to use <cite>mutate.py</cite> to generate a VCF file with simulated variants representing
a mutated sequence. We would, eventually, like to simulate reads from this mutated sequence. This is a two step process.
In the first step we use <cite>vcf2seq.py</cite> to write out the mutated sequence by combining the reference sequence with the
VCF file. <cite>vcf2seq.py</cite> also writes out a <cite>pos</cite> (position) file. In the next step we invoke <cite>reads.py</cite> to actually
generate the reads. Just like <cite>mutate.py</cite> has different variant generating models <cite>reads.py</cite> has different read generating
models simulating the read characteristics of different machines. <strong>For every read we generate we store POS and CIGAR
strings that correspond to a perfect alignment. We can use this to diagnose performance and errors in aligners and
variant callers</strong>. The POS and CIGAR are written into the qname field of the read and are easily extracted. The simple
program <cite>cheata.py</cite> will generate a perfect alignment for you from a simulated .bam file produced by <cite>reads.py</cite></p>
<div class="section" id="vcf2seq">
<h2>vcf2seq<a class="headerlink" href="#vcf2seq" title="Permalink to this headline">¶</a></h2>
<p>Running vcf2seq will generate a mutated sequence and a <cite>.pos</cite> file that contains important indexing information used by
<cite>reads.py</cite>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python vcf2seq.py README-DATA/porcine_circovirus_0.smalla README-DATA/pc_mutated 1 README-DATA/variants.vcf.gz  --ploidy=2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This generates two sequences <cite>pc_mutated_0.smalla</cite> and  having all the mutations described in the VCF file above. Using
a pen and paper we can work out what the mutated sequence should look like:</p>
<blockquote>
<div><blockquote>
<div><dl class="docutils">
<dt>C -&gt; G                                                                                  A -&gt; C                                                                                    T -&gt; C                                                                                                                                                                                                                                                                                               T -&gt; C                                                                                 A -&gt; G</dt>
<dd><div class="first last line-block">
<div class="line">|                                                                                         |                                                                                                                                                                                                                                                                                                    |                                                                                      |</div>
</div>
</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>ATGACGTATCCAAGGAGGCGTTACCGGAGAAGAAGACACCGCCCCCGCAGCCATCTTGGCCAGATCCTCCGCCGCCGCCCCTGGCTCGTCCACCCCCGCCACCGTTACCGCTGGAGAAGGAAAAACGGCATCTTCAACACCCGCCTCTCCCGCACCTTCGGATATACTATCAAGCGAACCACAGTCAAAACGCCCTCCTGGGCGGTGGACATGATGAGATTCAATATTAATGACTTTCTTCCCCCAGGAGGGGGCTCAAACCCCCGCTCTGTGCCCTTTGAATACTACAGAATAAGAAAGGTTAAGGTTGAATTCTGGCCCTGCTCCCCGATCACCCAGGGTGACAGGGGAGTGGGCTCCAGTGCTGTTATTCTAGATGATAACTTTGTAACAAAGGCCACAGCCCTCACCTATGACCCCTATGTAAACTACTCCTCCCGCCATACCATAACCCAGCCCTTCTCCTACCACTCCCGCTACTTTACCCCCAAACCTGTCCTAGATTCCACTATTGATTACTTCCAACCAAACAACAAAAGAAATCAGCTGTGGCTGAGACTACAAACTGCTGGAAATGTAGACCACGTAGGCCTCGGCACTGCGTTCGAAAACAGTATATACGACCAGGAATACAATATCCGTGTAACCATGTATGTACAATTCAGAGAATTTAATCTTAAAGACCCCCCACTTAACCCTTAG</dt>
<dd><dl class="first last docutils">
<dt>&#8212;&#8212;&#8212;&#8212;                                                                                  &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;                                                                  &#8212;&#8212;-                                                                       &#8212;&#8212;&#8212;&#8212;-                                                                                           &#8212;&#8212;                                                                                                                                                                                                &#8212;&#8212;&#8212;&#8211;</dt>
<dd>del                                                                                                del                                                                             del                                                                              del                                                                                                  del                                                                                                                                                                                                     del</dd>
</dl>
</dd>
</dl>
<p class="attribution">&mdash;&gt; work this out again</p>
</div></blockquote>
<p>and compare it to the generated one</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/pc_mutated_0.smalla&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="go">ATGACGTATCCAAGGAGGCGTTACCGGAGAAGAAGACACCGCCCCCGCAGCCATCTTGGCCAGATCCTCCGCCGCCGCCCCTGGCTCGTCCACCCCCGGCACTGGAGAAGGAAAAACGGCATCTTCAACACCCGCCTCTCCCGCACCTTCGGATATACTATCAAGCGAACCACAGTCCAAACGCCCTCGGTGGACATGATGAGATTCAATATTAATGACTTTCTTCCCCCAGGAGGGGGCTCAAACCCCCGCTCTGTGCCCCTTGAATAATAAGAAAGGTTAAGGTTGAATTCTGGCCCTGCTCCCCGATCACCCAGGGTGACAGGGGAGTGGGCTCCATTCAAGATGATAACTTTGTAACAAAGGCCACAGCCCTCACCTATGACCCCTATGTAAACTACTCCTCCCGCCATACCATAACCCAGCCCTTCTCCCGCTACTTTACCCCCAAACCTGTCCTAGATTCCACTATTGATTACTTCCAACCAAACAACAAAAGAAATCAGCTGTGGCTGAGACTACAAACTGCCGGAAATGTAGACCACGTAGGCCTCGGCACTGCGTTCGAAAACAGTATATACGACCAGGAATACAATATCCGTGTAACCATGTATGTGCAATTCTTTAATCTTAAAGACCCCCCACTTAACCCTTAG</span>
</pre></div>
</div>
</div>
<div class="section" id="reads">
<h2>reads<a class="headerlink" href="#reads" title="Permalink to this headline">¶</a></h2>
<p>We first create a parameter file. Note that we want to simulate reads from a diploid organism and so we pass in two
file names under <cite>input_sequences</cite>. This element (alongwith <cite>total_reads</cite> and <cite>read_ranges</cite>) must always be a list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>    <span class="s">&quot;input_sequences&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;README-DATA/pc_mutated_0.smalla&quot;</span><span class="p">,</span> <span class="s">&quot;README-DATA/pc_mutated_1.smalla&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s">&quot;total_reads&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s">&quot;is_this_ref_seq&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;read_ranges&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span>
<span class="gp">... </span>    <span class="s">&quot;output_file_prefix&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/sim_reads&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;read_model&quot;</span><span class="p">:</span> <span class="s">&quot;tiled_reads&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;model_params&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>        <span class="s">&quot;paired&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&quot;read_len&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&quot;template_len&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&quot;read_advance&quot;</span><span class="p">:</span> <span class="mi">50</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/read_par.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we run <cite>reads.py</cite> with an appropriate read parameter file to generate a bucket of reads.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python reads.py  --paramfile=README-DATA/read_par.json  --corrupt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This produces a BAM file (<cite>sim_reads.bam</cite>) with perfect reads from the mutated sequence. Because of the <cite>&#8211;corrupt</cite> option it
also produces <cite>sim_reads_c.bam</cite> which has corrupted reads. This uses the stock plugin which generates errors at the
inner ends of the reads with an exponential envelope.</p>
<p>Note that if we wanted to generate reads from a reference sequence we would simply feed <cite>reads.py</cite> with the sequence.</p>
</div>
<div class="section" id="cheata">
<h2>cheata<a class="headerlink" href="#cheata" title="Permalink to this headline">¶</a></h2>
<p>We can run <a href="#id22"><span class="problematic" id="id23">`</span></a>cheata.py`on this BAM file to generate perfect alignment</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python cheata.py --inbam=README-DATA/sim_reads.bam --outbam=README-DATA/aligned.bam  --heada=README-DATA/porcine_circovirus_0.smalla.heada&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now you can use <cite>samtools tview</cite> or <cite>tablet</cite> or <cite>IGV</cite> to open up <cite>aligned.bam</cite> and see the perfectly aligned assembly of
the data.</p>
<p>You can repeat the process with the corrupted reads to get a perfectly aligned BAM but with simulated corruption in the
reads.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python cheata.py --inbam=README-DATA/sim_reads_c.bam --outbam=README-DATA/aligned_c.bam  --heada=README-DATA/porcine_circovirus_0.smalla.heada&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing-samtools-mpileup">
<h1>Testing <cite>samtools mpileup</cite><a class="headerlink" href="#testing-samtools-mpileup" title="Permalink to this headline">¶</a></h1>
<p>Having done these steps, we can now test the <cite>samtools mpileup</cite> function and see if we can find back the variants we
put into the mutated sequence from which we just generated reads.</p>
<p>We first run <cite>mpileup</cite> on the perfect alignment</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shelly</span><span class="p">(</span><span class="s">&#39;samtools mpileup -uf Data/porcine_circovirus.fa README-DATA/aligned.bam | bcftools view -bvcg - &gt; README-DATA/var.raw.bcf&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shelly</span><span class="p">(</span><span class="s">&#39;bcftools view README-DATA/var.raw.bcf | vcfutils.pl varFilter -D100 &gt; README-DATA/mpileup.vcf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we compare the original VCF with  the detected one</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;tail -n -11 README-DATA/variants.vcf&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;tail -n -11 README-DATA/mpileup.vcf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The VCF entries should indicate identical variants from the <cite>mpileup</cite> command as we generated in the simulation.</p>
</div>
<div class="section" id="testing-bwa-alignment">
<h1>Testing BWA alignment<a class="headerlink" href="#testing-bwa-alignment" title="Permalink to this headline">¶</a></h1>
<p>How about using <cite>reads.py</cite> to generate some reads from a reference sequence and then checking how well a commonly used
aligner can align the reads?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python converta.py Data/adenovirus.fa README-DATA/adenovirus&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>    <span class="s">&quot;input_sequences&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;README-DATA/adenovirus_0.smalla&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s">&quot;coverages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s">&quot;is_this_ref_seq&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;read_ranges&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span>
<span class="gp">... </span>    <span class="s">&quot;output_file_prefix&quot;</span><span class="p">:</span> <span class="s">&quot;README-DATA/adeno_reads&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;read_model&quot;</span><span class="p">:</span> <span class="s">&quot;simple_reads&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&quot;model_params&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="gp">... </span>        <span class="s">&quot;paired&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&quot;read_len&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&quot;template_len&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">},</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;README-DATA/adeno_read_par.json&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python reads.py  --paramfile=README-DATA/adeno_read_par.json&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shelly</span><span class="p">(</span><span class="s">&#39;samtools bam2fq README-DATA/adeno_reads.bam &gt; README-DATA/raw_reads.fq&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;bwa index Data/adenovirus.fa&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shelly</span><span class="p">(</span><span class="s">&#39;bwa mem -p Data/adenovirus.fa README-DATA/raw_reads.fq &gt; README-DATA/adeno_aligned.sam&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shelly</span><span class="p">(</span><span class="s">&#39;samtools view -Sb README-DATA/adeno_aligned.sam &gt; README-DATA/temp.bam&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;samtools sort README-DATA/temp.bam README-DATA/adeno_aligned&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;samtools index README-DATA/adeno_aligned.bam&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python cheata.py split --inbam=README-DATA/adeno_aligned.bam&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">shell</span><span class="p">(</span><span class="s">&#39;python Analysis/diagnose_alignment.py --correctbam=README-DATA/adeno_aligned_correct.bam --wrongbam=README-DATA/adeno_aligned_wrong.bam  --smalla=README-DATA/adenovirus_0.smalla  --outpkl=README-DATA/bwa_adenovirus_stats.pkl  --outfig=README-DATA/bwa_adenovirus_stats.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You should end up with a page of plots telling you how well the aligner did its job</p>
<p>![Aligner summary figure]: (README-DATA/bwa_adenovirus_stats.png)</p>
<p>For further examples of what Mitty can do for you, please refer to the <cite>Examples</cite> directory and the <cite>Readme.md</cite>
file there to read along. For each of the programs listed above please run the <cite>-h</cite> option to learn the usage pattern.</p>
</div>
<div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>There are two branches in the repository:</p>
<blockquote>
<div>master - stable working code
dev    - code could be unstable/unworking but will have the latest experimental stuff going on</div></blockquote>
<p>The code requires the following non-standard modules</p>
<blockquote>
<div>BioPython   - pip install biopython &#8211;user
PyVCF       - pip install pyvcf &#8211;user
pysam       - pip install pysam &#8211; user</div></blockquote>
<p>The code requires the following external tools to run the examples</p>
<blockquote>
<div>bgzip       - to compress VCF file
tabix       - to index VCF file
samtools    - indexing fasta and converting between bam and sam etc
bwa         - alignments etc.</div></blockquote>
<div class="section" id="subdirectories">
<h2>Subdirectories<a class="headerlink" href="#subdirectories" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Params      - example parameter files for mutate.py and reads.py
Recipes     - snippets of code (shell scripts and python scripts) to do/show particular tasks. useful for devs and</p>
<blockquote>
<div>users alike</div></blockquote>
<p>Data        - test data for the programs
Plugins     - directory where simulation models are stored</p>
</div></blockquote>
</div>
<div class="section" id="files-and-formats">
<h2>Files and formats<a class="headerlink" href="#files-and-formats" title="Permalink to this headline">¶</a></h2>
<p>## VCF</p>
<p><cite>vcf2seq.py</cite> currently handles a specific interpretation of the VCF. In the most liberal interpretation of the VCF the
REF sequence corresponds to bases matching the reference starting at POS and those bases are replaced by the bases found
in ALT. Any number of bases in ALT may match the REF in any place (though this is not very useful to us).</p>
<p>Mitty has a more strict interpretation of the VCF. In Mitty&#8217;s interpretation, at most, the first base
of REF will match with ALT. All other bases must be different. All variants can be coded in this manner:</p>
<p>Say our original sequence is <cite>ATCGGATC</cite></p>
<blockquote>
<div><blockquote>
<div>POS   REF     ALT</div></blockquote>
<p>Deletion      1   ATCG     A     -&gt; AGATC
Deletion      2   TCG      .     -&gt; AGATC     (Though this form is interpreted by vcf2seq it is never produced by mutate.py)
Deletion      1    A       .     -&gt; TCGGATC
Insertion     0    .      TTT    -&gt; TTTATCGGATC
Insertion     1    A      AGGG   -&gt; AGGGTCGGATC
SNP           1    A       G     -&gt; GTCGATC</p>
</div></blockquote>
<p>In addition to this Mitty adds an additional code to the genotype (GT) field 1/0. This is because in the simulation we
have actual access to which copy of a diploid sequence has a heterozygous mutation. Therefore we use the GT field to
encode on which set of the sequence the variant exists. Note that VCF files produced by Mitty never have 0/0 as we do
not include any standard variant from a library.</p>
<p>## &#8220;Buffer bases&#8221; between simulated variants</p>
<p>If we have variants adjacent to each other the most parsimonious description of the resulting variation can be different
from the original variants.</p>
<p>For example, considering <cite>M=ATCGATCG</cite> and an insertion and deletion as follows</p>
<blockquote>
<div>POS REF ALT
1   A   ACC
1   AT  A</div></blockquote>
<p>We get</p>
<blockquote>
<div><blockquote>
<div>1  2345678</div></blockquote>
<p>R    A  TCGATCG
M    ACC CGATCG</p>
</div></blockquote>
<p>This can, actually, be most parsimoniously expressed as</p>
<blockquote>
<div><blockquote>
<div>1 2345678</div></blockquote>
<p>R    A TCGATCG
M    ACCCGATCG</p>
</div></blockquote>
<p>Which is a single base insertion followed by a SNP</p>
<blockquote>
<div>POS REF ALT
1   A  AC
2   T  C</div></blockquote>
<p>For reasons of such ambiguity Mitty places a minimum 1 base &#8220;buffer&#8221; between variants, making the generated variant
identical to the most parsimonious description.</p>
</div>
</div>
<div class="section" id="dev-notes">
<h1>Dev notes<a class="headerlink" href="#dev-notes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="plugin-system-for-simulation-models">
<h2>Plugin system for simulation models<a class="headerlink" href="#plugin-system-for-simulation-models" title="Permalink to this headline">¶</a></h2>
<p>Mitty implements models for variant and read simulation as Python modules located in the Plugins directory. The modules
need to expose a few key functions that <cite>mutate.py</cite> and <cite>reads.py</cite> use to determine variant and read characteristics.
Mitty infers the module name from the name given in the parameter .json file. Mitty comes with some stock models for
variant and read simulation which can be used as example code.</p>
<p>### Random number generators, blocked computation etc.
You will note that the stock plugins accept one or more inputs that serve as seeds for internal random number
generators. These seeds need to be specified in the simulation parameter files and ensure reproducibility of
simulations.</p>
<p>Some of the models use several, independently seeded, random number generators for different variables (e.g.
insertion length and insertion position) to avoid unexpected interactions between such simulated variables. The
algorithms are also designed such that the simulation results are independent of block size.</p>
</div>
<div class="section" id="algorithms">
<h2>Algorithms<a class="headerlink" href="#algorithms" title="Permalink to this headline">¶</a></h2>
<p>### Variants, reads and CIGARS
One big goal of Mitty is to serve up realistic test data for bioinformatics algorithms, from aligners to variant
callers. Testing whether a variant caller is correctly working on the simulated data is relatively easy: we simply
compare the variant caller&#8217;s VCF file with the answer book VCF generated by Mitty. It is, however, slightly more involved
to deduce if an aligner is correctly aligning the simulated reads, and to diagnose how the performance of an aligner is
affecting the accuracy of a variant caller. To this end Mitty has a system to compute the correct read position and
CIGAR for each simulated read. This information is stored in the read&#8217;s qname string so that it is easily accessible
to diagnostic programs.</p>
<p>In order to generate reads based on a given VCF file and a reference sequence we go through a two step process.
We first generate the mutated sequence (<cite>mut_seq</cite>) along with some other information that encodes the difference between
each base in the <cite>mut_seq</cite> and corresponding positions on the <cite>ref_seq</cite>. We then generate reads from the <cite>mut_seq</cite> using
the sidecar information to compute the correct POS values and CIGAR strings for the reads.</p>
<p>The algorithm is best introduced through a series of examples. In the examples the reference sequence is labelled <cite>R</cite> and
the mutated sequence is labeled <cite>M</cite>. The information for setting the POS and CIGAR for the read is taken from an
array <cite>pos</cite> that accompanies <cite>M</cite></p>
<p>#### Generating <cite>pos</cite></p>
<p>Let <cite>R = ACTGACTG</cite></p>
<p>Consider a single base insertion at position 1</p>
<blockquote>
<div><p>POS REF ALT
1   A   AT</p>
<blockquote>
<div>1 2345678</div></blockquote>
<p>R    A CTGACTG
M    ATCTGACTG
pos  1223456789</p>
</div></blockquote>
<p>Consider a multiple base insertion at position 1</p>
<blockquote>
<div><p>POS REF ALT
1   A   ATT</p>
<blockquote>
<div>1  2345678</div></blockquote>
<p>R    A  CTGACTG
M    ATTCTGACTG
pos  12223456789</p>
</div></blockquote>
<p>Consider a multiple base insertion at last position</p>
<blockquote>
<div><p>POS REF ALT
8   G   GTT</p>
<blockquote>
<div>12345678</div></blockquote>
<p>R    ACTGACTG
M    ACTGACTGTT
pos  12345678999</p>
</div></blockquote>
<p>Consider a multiple base deletion</p>
<blockquote>
<div><p>POS REF ALT
2   CTG  C</p>
<blockquote>
<div>12345678</div></blockquote>
<p>R    ACTGACTG
M    AC  ACTG
pos  12  56789</p>
</div></blockquote>
<p>Consider a SNP, an insertion and a deletion</p>
<blockquote>
<div><p>POS REF ALT
2   C   T
4   G   GTT
6   CTG C</p>
<blockquote>
<div>1234  5678</div></blockquote>
<p>R    ACTG  ACTG
M    ATTGTTAC
pos  123455569</p>
</div></blockquote>
<p><cite>pos</cite> is generated by copying over the index from <cite>R</cite>. When we encounter an insertion we copy over the index of the next
reference base as many times as there is an insertion. Deletions are simply skipped. For the purposes of computing <cite>pos</cite>
we also add an imaginary base position at the end of the reference sequence (9 in this case)</p>
<p>You can &#8220;read along&#8221; to these examples by running <cite>python vcf2seq.py test -v</cite> and seeing how different functions in
<cite>vcf2seq.py</cite> implement these algorithms</p>
<p>#### Generating CIGARS and POS for reads from <cite>pos</cite>
Consider our last example and some reads from <cite>M</cite></p>
<blockquote>
<div><blockquote>
<div>1234  5678</div></blockquote>
<p>R    ACTG  ACTG
M    ATTGTTAC
pos  123455569</p>
<blockquote>
<div><dl class="docutils">
<dt>++++&#8212;&#8212;&#8212;&gt; POS = 1 (The first pos value we encounter)</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 4M  (2-1=1 -&gt; 1M</dt>
<dd>3-2=1 -&gt; 1M
4-3=1 -&gt; 1M
5-4=1 -&gt; 1M)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>M    ATTGTTAC
pos  123455569</p>
<blockquote>
<div><dl class="docutils">
<dt>++++&#8212;&#8212;&#8211;&gt; POS = 2 (The first pos value we encounter)</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 3M1I  (3-2=1 -&gt; 1M</dt>
<dd>4-3=1 -&gt; 1M
5-4=1 -&gt; 1M
5-5=0 -&gt; 1I)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>M    ATTGTTAC
pos  123455569</p>
<blockquote>
<div><dl class="docutils">
<dt>++++&#8212;&#8212;-&gt; POS = 3</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 2M2I  (4-3=1 -&gt; 1M</dt>
<dd>5-4=1 -&gt; 1M
5-5=0 -&gt; 1I
5-5=0 -&gt; 1I)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>M    ATTGTTAC
pos  123455569</p>
<blockquote>
<div><dl class="docutils">
<dt>++++&#8212;&#8211;&gt; POS = 5</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 2I2M  (5-5=0 -&gt; 1I</dt>
<dd>5-5=0 -&gt; 1I
6-5=1 -&gt; 1M
9-6=3 -&gt; 1M + 2D) The D only comes into play if our read crosses the deletion</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>To see how a deletion affects our POS and CIGAR consider another previous example</p>
<blockquote>
<div><p>POS REF ALT
2   CTG  C</p>
<blockquote>
<div>12345678</div></blockquote>
<p>R    ACTGACTG
M    AC  ACTG
pos  12  56789</p>
<blockquote>
<div><dl class="docutils">
<dt>++  ++&#8212;&#8212;-&gt; POS = 1</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 2M2D2M  (2-1=1 -&gt; 1M</dt>
<dd>5-2=3 -&gt; 1M + 2D The 2D comes into play because the read crosses the boundary
6-5=1 -&gt; 1M
7-6=1 -&gt; 1M)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>Example of an unmapped read</p>
<blockquote>
<div><p>POS REF ALT
2   C  CAATTGG</p>
<blockquote>
<div>12      345678</div></blockquote>
<p>R    AC      TGACTG
M    ACAATTGGTGACTG
pos  123333333456789</p>
<blockquote>
<div><dl class="docutils">
<dt>++++&#8212;&#8212;-&gt; POS = 3</dt>
<dd><dl class="first last docutils">
<dt>CIGAR = 4I  (3-3=0 -&gt; 1I</dt>
<dd>3-3=0 -&gt; 1I
3-3=0 -&gt; 1I
3-3=0 -&gt; 1I)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>For a read to be mapped, there has to be at least one M. Since there are no Ms we discard the POS and CIGAR as this
is an unmapped read</p>
</div></blockquote>
<p><cite>reads.py</cite> generates simulated reads from <cite>mut_seq</cite> based on the read model. Using the <cite>pos</cite> arrays it
also generates appropriate alignment information (POS and CIGAR) that is stored in the qname string.
(Note that while the BAM specs do not place a limit on the length of the qname string both Tablet and IGV expect a
string with length &lt; 255 characters. It is possible that the qname will exceed this and you won&#8217;t be able to open a
set of simulated reads using tools that arbitrarily limit the qname). If no <cite>pos</cite> file is supplied <cite>reads.py</cite> assumes
we are taking reads from a reference sequence and the POS values are actual positions of the reads and all the cigars
are of the form <cite>100M</cite> (For e.g. 100 base reads).</p>
<p>Computing POS: For every read, the POS value is simply the index from <cite>pos</cite> corresponding to the first base of the read
EXCEPT for unmapped reads.</p>
<p>Computing the CIGAR:</p>
<ol class="arabic simple">
<li>Initialize the base counter to <cite>None</cite>, set mapped flag to <cite>False</cite></li>
<li>Step through the each base of the read and look at the difference in <cite>pos</cite> values <cite>dp</cite></li>
<li>If <cite>dp==1</cite>, if the counter is any thing other than <cite>M</cite>, flush it. Set or increment counter as <cite>M</cite>. Set mapped flag to <cite>True</cite></li>
<li>If <cite>dp==0</cite>, if the counter is other than <cite>I</cite>, flush it. Set or increment counter as <cite>I</cite></li>
<li>If <cite>dp&gt;1</cite>, if the counter is other than <cite>M</cite>, flush it. Set and flush counter as <cite>M</cite>, set counter as <cite>D</cite> to be dp-1</li>
<li>Continue from 2 until done.</li>
<li>Flush any counter other than <cite>D</cite></li>
<li>If the mapped flag is <cite>False</cite> reset POS and CIGAR - this is an unmapped read.</li>
</ol>
<p>You can &#8220;read along&#8221; to these examples by running <cite>python reads.py test -v</cite> and seeing how different functions in
<cite>reads.py</cite> implement these algorithms</p>
</div>
</div>
<div class="section" id="misc-design-choices">
<h1>Misc design choices<a class="headerlink" href="#misc-design-choices" title="Permalink to this headline">¶</a></h1>
<div class="section" id="hdf5-for-whole-genome-file">
<h2>HDF5 for Whole genome file<a class="headerlink" href="#hdf5-for-whole-genome-file" title="Permalink to this headline">¶</a></h2>
<p>I went from complete block processing of reading fasta files to reading in whole sequences. This is because for our use
case (Human) the individual chromosomes are small enough to fit even on modest machines.</p>
<p>### Choice to output a mutated sequence as a whole
Though generating a whole mutated sequence uses a lot of disk space, I chose this approach as it ended up being simpler
than coming up with an algorithm for generating reads on the fly based ona  VCF file. In the future the code may be
converted to do on the fly generation.</p>
<p>### Parameter files for mutate
1. I chose to use parameter files because we often want to rerun experiments and it became clear early on that there would
be a lot of parameters.
1. I chose to use python for the parameter file for parsimony and flexibility
1. The parameter distribution between file and command line was based on predictions of which parameters we could
experiment with most during testing
1. At this time I do not know whether having everything on the commandline would be better for PIPITOR or if param files
are preferred for Platform integration, but either way is a short code reorganization that can be done quickly at the
time of integration.</p>
<p>### POS files
These are simple binary files carrying unsigned 4 byte int information. This is enough to handle index/index diff sizes
for human genome sizes, though if we ever work on heavily mutated specimens of the loblolly pine, perhaps we have to
go to 8 byte ints ...</p>
<p>Python&#8217;s native mmap can&#8217;t do proper offsets ... should we use numpy?</p>
</div>
</div>
<div class="section" id="notes">
<h1>Notes:<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="sequence-data">
<h2>Sequence data<a class="headerlink" href="#sequence-data" title="Permalink to this headline">¶</a></h2>
<p>Sequence data used as examples are from the NIH:</p>
<p>1. <cite>porcine_circovirus.fa</cite> [porcine circovirus sequence][porcine] (702 b)
1. <cite>altered_porcine.fa</cite> taken from above but with &#8216;N&#8217;s and lowercase bases inserted to test converters
1. <cite>adenovirus.fa</cite> [Porcine adenovirus 3 DNA, complete genome][adeno] (34094 b))
1. <cite>herpes.fa</cite> [Human herpes virus 1 GenBank: KC140233.1][herpes] (717 b)
1. <cite>parvovirus.fa</cite> [Parvovirus H1, complete genome NC_001358.1][parvovirus]</p>
<p>[porcine]: <a class="reference external" href="http://www.ncbi.nlm.nih.gov/nuccore/AY735451.1">http://www.ncbi.nlm.nih.gov/nuccore/AY735451.1</a>
[adeno]: <a class="reference external" href="http://www.ncbi.nlm.nih.gov/nuccore/AB026117.1">http://www.ncbi.nlm.nih.gov/nuccore/AB026117.1</a>
[herpes]: <a class="reference external" href="http://www.ncbi.nlm.nih.gov/nuccore/448872318">http://www.ncbi.nlm.nih.gov/nuccore/448872318</a>
[parvovirus]: <a class="reference external" href="http://www.ncbi.nlm.nih.gov/nuccore/NC_001358.1">http://www.ncbi.nlm.nih.gov/nuccore/NC_001358.1</a></p>
<p>tmat = &#8220;&#8221;&#8221;
0.32654629,  0.17292732,  0.24524503,  0.25528135
0.3489394,   0.25942695,  0.04942584,  0.3422078
0.28778188,  0.21087004,  0.25963262,  0.24171546
0.21644706,  0.20588717,  0.24978216,  0.32788362&#8221;&#8220;&#8221;</p>
<p>[[float(col) for col in row.split(&#8216;,&#8217;)] for row in tmat.strip().split(&#8216;n&#8217;)]</p>
</div>
</div>


          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2015,Seven Bridges Genomics
(kaushik.ghose@sbgenomics.com).
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.1.1dev',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>